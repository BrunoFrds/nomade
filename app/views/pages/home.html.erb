<!-- Lien vers les réservations, visible uniquement si l'utilisateur est connecté -->
<% if user_signed_in? %>
  <%= link_to "Voir les réservations", reservations_path%>
<% end %>

<!-- Formulaire de réservation, caché si l'utilisateur est connecté -->
<% unless user_signed_in? %>

  <!-- Formulaire de réservation -->
  <%= form_with(model: @reservation, url: reservations_path, method: :post, local: true, scope: :reservation, html: { class: "reservation-form", data: { controller: "reservation" } }) do |f| %>

    <!-- Bloc 1 : date / heure / nombre de personnes -->
    <div class="reservation-info">
      <div class="form-group">
        <%= f.label :people, "Personnes" %>
        <%= f.select :people, options_for_select([
            "1", "2", "3", "4", "5",
            "6", "7", "8", "9", "10"
          ]), class: "guest-select" %>
      </div>

      <div class="form-group">
        <%= f.label :date %>
        <%= f.text_field :date, value: Date.today, data: { controller: "datepicker" } %>
      </div>

      <div class="form-group">
        <%= f.label :time %>
        <%= f.select :time, options_for_select([
            "12:00", "12:30", "13:00", "13:30",
            "14:00", "14:30", "19:00", "19:30",
            "20:00", "20:30", "21:00", "21:30"
          ]), class: "time-select" %>
      </div>
    </div>

    <!-- Bloc 2 : infos client, caché au départ -->
    <div class="client-info" style="display: none;">
      <div class="form-group">
        <%= f.label :first_name, "Prénom" %>
        <%= f.text_field :first_name, placeholder: "Votre prénom" %>
      </div>

      <div class="form-group">
        <%= f.label :last_name, "Nom" %>
        <%= f.text_field :last_name, placeholder: "Votre nom" %>
      </div>

      <div class="form-group">
        <%= f.label :email, "Email" %>
        <%= f.email_field :email, placeholder: "Votre email" %>
      </div>

      <div class="form-group">
        <%= f.label :phone, "Téléphone" %>
        <%= f.telephone_field :phone, placeholder: "Votre numéro" %>
      </div>
    </div>

    <!-- Bouton de validation -->
    <%= f.submit "Valider", class: "btn-reserve", data: { action: "click->reservation#handleClick" } %>
  <% end %>
<% end %>

<!-- Affichage de la réservation de l'utilisateur si elle existe -->
<% if @user_reservation %>
  <div class="user-reservation">
    <h3>Votre réservation</h3>
    <p><strong>Date :</strong> <%= @user_reservation.date.strftime("%d/%m/%Y") %></p>
    <p><strong>Heure :</strong> <%= @user_reservation.time %></p>
    <p><strong>Personnes :</strong> <%= @user_reservation.people %></p>
    
    <!-- Bouton supprimer -->
    <%= link_to "Annuler", reservation_path(@user_reservation.token),
          data: { turbo_method: :delete, turbo_confirm: "Êtes-vous sûr ?" },
          class: "btn-delete" %>
  </div>
<% end %>

<!-- Affichage des plats -->
<div class="menu">
  <!-- Formulaire d'ajout de plat, visible uniquement si l'utilisateur est connecté -->
  <% if user_signed_in? %>
    <div data-controller="toggle-form" class="add-dish">
      <button data-action="click->toggle-form#toggle">Ajouter</button>
      <div data-toggle-form-target="form" style="display:none;">
        <%= form_with(model: @dish, url: dishes_path, method: :post, html: { class: "add-form"}) do |f| %>
          <%= f.label :name, "Nom" %>
          <%= f.text_field :name %>
          <%= f.label :category %>
          <%= f.select :category, options_for_select(@dishes.group_by(&:category).keys) %>
          <%= f.label :price, "Prix" %>
          <%= f.number_field :price%>
          <%= f.label :description, "Description" %>
          <%= f.text_area :description %>

          <%= f.submit "Valider", class: "btn-add" %>
        <% end %>
      </div>
    </div>
    <%= link_to "Log out", destroy_user_session_path, data: {turbo_method: :delete}, class: "dropdown-item" %>
  <% end %>

  <!-- Groupement des plats par catégorie et affichage -->
  <% @dishes.group_by(&:category).each do |category, dishes| %>
    <div>
      <h2><%= category %></h2>
    </div>
    <% dishes.each do |dish| %>
      <div class="dish">
        <div class="dish-header">
          <p><%= dish.name %></p>
          <p><%= dish.price %></p>
            <!-- Formulaire d'édition et de suppression, visible uniquement si l'utilisateur est connecté -->
            <% if user_signed_in? %>
              <div data-controller="toggle-form" class="add-dish">
                <button data-action="click->toggle-form#toggle">Modifier</button>
                <div data-toggle-form-target="form" style="display:none;">
                  <%= form_with(model: @dish, url: dish_path(dish), method: :patch, html: { class: "update-form"}) do |f| %>
                    <%= f.label :name, "Nom" %>
                    <%= f.text_field :name %>
                    <%= f.label :price, "Prix" %>
                    <%= f.number_field :price%>
                    <%= f.label :description, "Description" %>
                    <%= f.text_area :description %>

                    <%= f.submit "Valider", class: "btn-update" %>
                  <% end %>
                </div>
              </div>
              <%= link_to "Delete", dish_path(dish), data: {turbo_method: :delete, turbo_confirm: "Êtes-vous sûr?"} %>
            <% end %>
        </div>
        <div class="dish-description">
          <p><%= dish.description %></p>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
